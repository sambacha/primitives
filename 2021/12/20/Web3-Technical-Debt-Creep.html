<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Web3 Technical Debt Creep | Primitives</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Web3 Technical Debt Creep" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Mythical Web3 Developer Experience" />
<meta property="og:description" content="The Mythical Web3 Developer Experience" />
<meta property="og:site_name" content="Primitives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-20T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Web3 Technical Debt Creep" />
<script type="application/ld+json">
{"headline":"Web3 Technical Debt Creep","dateModified":"2021-12-20T00:00:00+00:00","datePublished":"2021-12-20T00:00:00+00:00","url":"/primitives/2021/12/20/Web3-Technical-Debt-Creep.html","description":"The Mythical Web3 Developer Experience","mainEntityOfPage":{"@type":"WebPage","@id":"/primitives/2021/12/20/Web3-Technical-Debt-Creep.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="/primitives/feed.xml" title="Primitives" /><!-- Emoji Favicon  -->
  <!-- Favicon -->
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ„</text></svg>"
  />
  <!-- <link rel="shortcut icon" href="/primitives/favicon.ico"> -->

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu"
    crossorigin="anonymous"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
    integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
    crossorigin="anonymous"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/primitives/assets/css/main.min.css" />
</head>
<body><!-- Navigation -->
<nav
  class="navbar navbar-default navbar-custom navbar-fixed-top invert"
>
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <a class="navbar-brand" href="/primitives/">Primitives</a>
      <button class="navbar-toggle" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/primitives/">Home</a>
          </li><li>
            <a href="/primitives/about/">About</a>
          </li><li>
            <a href="/primitives/archive/">Archive</a>
          </li><li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fas fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>
<!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fas fa-chevron-down"></i>
    </span>
  </div>

  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form>
          <input type="text" id="search-input" placeholder="$ grep..." />
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>
<!-- Post Header --><header
  class="intro-header style-text"
>
  <div class="header-mask"></div><div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags"></div>
          <h1>Web3 Technical Debt Creep</h1>
          <h2 class="subheading"></h2>
          <span class="meta"
            >Posted by sambacha on December 20, 2021</span
          >
        </div>
      </div>
    </div>
  </div>
</header><!-- Post Content -->
<style>
  /* Place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: 0.1em;
    }
  }
</style>
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"
      ><h1 id="the-mythical-web3-developer-experience">The Mythical Web3 Developer Experience</h1>

<blockquote>
  <p>Engineering UX hurdles encountered in Web3</p>
</blockquote>

<p>Note: This is a summary of internal GitHub tickets and discussions in the form of a blog post.</p>

<h2 id="introduction">Introduction</h2>

<p>This ticket has been created with the sole purpose of discussing current issues discovered while trying to integrate our JSON RPC endpoint within SushiSwap and the different wallet providers. The idea is to have clear once and for all, what the limitations are, what we can do to overcome them and if we need to request guidance from the Sushi team.</p>

<p>To achieve that, Iâ€™ve taken the following approach as described below:</p>

<ul>
  <li>Describe how things currently work in terms of Sushiâ€™s front-end implementation for all providers.</li>
  <li>Describe how the workflow works for MetaMask, what we had tried previously to overcome limitations and the remaining issues with this implementation.</li>
  <li>Describe how the workflow works for WalletConnect, what we had tried previously to overcome limitations and the remaining issues with this implementation.</li>
  <li>Conclusions</li>
</ul>

<p>Without further ado, letâ€™s dive in.</p>

<h2 id="what-is-the-base-implementation">What is the base implementation</h2>

<p>In a perfect world, ideally in Sushiâ€™s front-end, we would like to change the RPC endpoint definition and use ours, like this:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145994476-989245b2-058e-4bc8-bafc-3f7b3267524b.png" alt="image" /></p>

<p>Theoretically, by just changing the RPC provider for the networks we are interested in, all transactions should be routed to that defined RPC endpointâ€¦ but itâ€™s not the case, as we all already know. So changing this value will only make the UI request generic information like the current block number and several batched calls.</p>

<p>The code that is responsible of doing that in Sushiâ€™s is the implementation of <code class="language-plaintext highlighter-rouge">NetworkConnector</code> and <code class="language-plaintext highlighter-rouge">MiniRpcProvider</code>:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146026549-8d2af937-af5c-4f97-9a07-616f6903f32b.png" alt="image" /></p>

<p>Right now, in Sushiâ€™s front-end, whenever a user decides to Swap a pair of Tokens, <a href="https://github.com/sushiswap/sushiswap-interface/blob/canary/src/hooks/useSwapCallback.ts">the current implementation can be located in <code class="language-plaintext highlighter-rouge">useSwapCallback</code></a>. That file, in general terms, is responsible for making such important action. So, for example, the code responsible for creating the transaction and broadcasting to the network can be seen in the screenshot below:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145996172-1f3946aa-014f-4455-849d-0d68b65f8805.png" alt="image" /></p>

<p>As we can notice from the screenshot above, Sushiâ€™s front-end obtains a reference to the <code class="language-plaintext highlighter-rouge">library.getSigner()</code>, which is a Wallet connector that refers back to a specific implementation (like MetaMask, WalletConnect, Portis, etc.), populates the transaction information retrieved from the UI, leaves to the specific implementation to fill remaining details and if everything goes well sends the transaction to the network.</p>

<p>In general, we can simplify the code to be something like:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nx">library</span>
  <span class="p">.</span><span class="nx">getSigner</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span> <span class="p">...</span><span class="nx">tx</span> <span class="p">})</span> <span class="c1">// Tx is populated with real information from the user</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">()</span> <span class="c1">// The hash is added to the UI that keeps polling for the TX</span>
  <span class="p">.</span><span class="nx">error</span><span class="p">()</span> <span class="c1">// If something wrong happens, like the user cancelling the TX or any other kind of error, it's being handled here</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>And this is the common ground for all wallet providers. So letâ€™s move now to specific implementations.</p>

<h2 id="metamask">MetaMask</h2>

<h3 id="current-flow">Current flow</h3>

<p>In the case of MetaMask, the flow is the following:</p>

<p>The user is connected with MetaMask:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145997849-a108199c-c6e1-41df-bd4a-52eeaec1f1cd.png" alt="image" /></p>

<p>And wants to swap these tokens for a specific amount:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145998002-bd773f01-8411-446f-aa05-a50af6de584f.png" alt="image" /></p>

<p>A new pop-up appears showcasing MetaMaskâ€™s modal for sending a Transaction:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145998229-6e103b67-7cbb-43b9-a8be-71a765039e9d.png" alt="image" /></p>

<p>In there, the user is able, among other things, to <strong>edit the estimated gas fee</strong> (if he wants to, itâ€™s an entirely optional step):</p>

<p><img src="https://user-images.githubusercontent.com/82811/145998346-cbf834d5-f3fa-4f85-ad9f-38ff7583bd45.png" alt="image" /></p>

<p>And once he is happy, he can proceed to send the transaction to the network by using MetaMaskâ€™s Infura default RPC endpoint for <code class="language-plaintext highlighter-rouge">mainnet</code>.</p>

<p><strong>Known Facts for MetaMask</strong>:</p>

<ul>
  <li>We already know their default Ethereum <code class="language-plaintext highlighter-rouge">mainnet</code> RPC provider uses their Infura connection.</li>
  <li>We also already know they donâ€™t allow us to use their <a href="https://docs.metamask.io/guide/rpc-api.html#other-rpc-methods">RPC method <code class="language-plaintext highlighter-rouge">wallet_addEthereumChain</code></a> if the network conflicts with one of their defined set of networks (i.e.: <code class="language-plaintext highlighter-rouge">mainnet</code>).</li>
</ul>

<h3 id="previous-solution-trick-metamask-checks-for-network-id">Previous Solution: Trick MetaMask checks for Network Id</h3>

<p>In issue #880 we were researching a potential alternative solution to trick MetaMask to believe the network we were adding was not for <code class="language-plaintext highlighter-rouge">mainnet</code>, but a completely random one.</p>

<p>The flow was designed to incite the user to switch to our RPC endpoint by placing a prominent button and using a custom <code class="language-plaintext highlighter-rouge">InjectedConnector</code> in charge of tricking MetaMask to believe we werenâ€™t adding network for <code class="language-plaintext highlighter-rouge">mainnet</code>.</p>

<p><a href="https://github.com/manifoldfinance/backbone-platform/issues/880#issuecomment-945977093">This was the original comment thread</a> where I give a very detailed explanation on how it works, and below there are the key points and screenshots of that flow:</p>

<p><img src="https://user-images.githubusercontent.com/82811/137774088-b9c336c1-576d-418f-8508-2e3320e34601.png" alt="image" /></p>

<p>If itâ€™s the first time the user is adding our network, it will try to add the network:</p>

<p><img src="https://user-images.githubusercontent.com/82811/137774282-5a7041c4-c515-4901-8448-cef032db8204.png" alt="image" /></p>

<p>And switch to it:</p>

<p><img src="https://user-images.githubusercontent.com/82811/137774406-af492a01-c894-4081-83a6-53767cbbef75.png" alt="image" /></p>

<p>As it turned out, Sushi didnâ€™t want to add the Manifold button to switch/add our RPC network. Without that, thereâ€™s no point of using the <code class="language-plaintext highlighter-rouge">InjectedConnector</code> anymore as it was designed only for handling that particular case and <strong>nothing else</strong>.</p>

<p>In this aspect, <strong>itâ€™s better to suggest the user use our RPC endpoint via a pop-up or something more prominent</strong> as adding manually a network that overrides <code class="language-plaintext highlighter-rouge">mainnet</code> is possible (BUT ONLY IF THE USER DOES IT). We can see it in the screenshot below:</p>

<p><img src="https://user-images.githubusercontent.com/82811/136415403-07edd59b-332d-4b35-9171-e7d244194375.png" alt="image" /></p>

<h3 id="alternative-solution-sign-the-tx-ourselves">Alternative Solution: Sign the tx ourselves</h3>

<p>Back in August, we were adding support to <code class="language-plaintext highlighter-rouge">manifold_sendTransaction</code>, and we took inspiration from what ArcherDAO did on Sushiâ€™s front-end. Their implementation can be summarized as:</p>

<p>1) The user needs to configure the front-end to use ArcherDAO explicitly.
2) The swap UI changed accordingly to display extra information like giving the Miner tips.
3) Whenever the user sends the TX to ArcherDAO relayer if using MetaMask or any other provider, it signs the tx manually and makes a <code class="language-plaintext highlighter-rouge">post</code> request to the endpoint.</p>

<p>We copied the same approach for our use case, removing extra superfluous information we didnâ€™t need (back in August, we werenâ€™t a compliant RPC endpoint, and that approach worked well).</p>

<p>Re-using that idea, we can use it for our RPC endpoint as well, as can be seen in the following screenshots:</p>

<p>We add in expert settings the option to use <code class="language-plaintext highlighter-rouge">OpenMEV</code> (it can be turned on by default):</p>

<p><img src="https://user-images.githubusercontent.com/82811/146009734-300f0555-a0f3-4c9e-b393-d4f14d8a2051.png" alt="image" /></p>

<p>The usual sign message UI appears:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146010260-86f5a632-5b7b-466e-afdc-f1749ae2613c.png" alt="image" /></p>

<p>The TX is relayed to Flashbots (although that one failed):</p>

<p><img src="https://user-images.githubusercontent.com/82811/146010435-aa06d943-c377-445a-b87a-37db0082f789.png" alt="image" /></p>

<p>The above screenshots are the actual workflow that <a href="https://github.com/manifoldfinance/sushiswap-interface/commit/704ad80c63c20b622944939361947bd48ef261c5#diff-686eddb0e7f6457b55065661febd02eddda11d03b5350f62fd7dc13f275a08d0R297">I implemented yesterday and refined today on this branch</a>.</p>

<p>There are a couple of downsides of this approach:</p>

<ul>
  <li>The user signs a message, so the UI is shit as it only displays a string of text. We can improve the UI of whatâ€™s displayed on the user by using <a href="https://docs.metamask.io/guide/signing-data.html#sign-typed-data-v4">Sign Typed Data V4 spec</a> that corresponds to <a href="https://eips.ethereum.org/EIPS/eip-712">EIP-712</a>, but I know there are incompatibilities among different wallets implementations that we canâ€™t ignore. I reckon this can be a secondary task to improve UX and not necessary for right now.</li>
  <li>But more importantly, we need to re-implement the whole UI to allow the user to specify particular fields like Priority, Gas Limit, Max Fee and so on that MetaMask, WalletConnect, and other wallet implementations gives us for free. <strong>Whoâ€™s going to be in charge of doing that? Would it be somebody from Sushi? There are certaint aspects we need to take into consideration.</strong> Right now, the current implementation takes default values and doesnâ€™t allow to customize anything at all.</li>
  <li>If we use WalletConnect to sign the message, in my tests that I conducted with Trust Wallet that implements the standard, it doesnâ€™t work correctly, and it doesnâ€™t return the signed data to the front-end (more on itâ€™s associated section).</li>
</ul>

<h2 id="walletconnect">WalletConnect</h2>

<h3 id="current-flow-1">Current flow</h3>

<p>After explaining everything related to MetaMask, letâ€™s rewind back and take the current implementation that is being used right now on Sushiâ€™s. As a user if I want to use WalletConnect, the flow is the following:</p>

<p>The user selects WalletConnect:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146016387-4722f0ce-ad46-4a52-bb18-e728144c025b.png" alt="image" /></p>

<p>A QR code appears to be scanned:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146016783-7b3c2c55-2030-4c1f-b51c-6c432a57909d.png" alt="image" /></p>

<p>And once everything is finished, the link is established between the Wallet and Sushiâ€™s front-end.</p>

<p>Now the user is able to conduct regular swap operations like below:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145998002-bd773f01-8411-446f-aa05-a50af6de584f.png" alt="image" /></p>

<p>And in the phone wallet the following UI appears:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146017656-09a28e56-f680-48e0-88f8-c523fefa15f6.jpg" alt="photo_2021-12-14_15-30-59" /></p>

<p>And the user is able to configure certain aspects of the TX like on MetaMask:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146017767-17fbdd75-4775-4bf6-98c5-0d2d359547ca.jpg" alt="photo_2021-12-14_15-31-58" /></p>

<p>In terms of the implementation, in Sushiâ€™s thereâ€™s a definition to use the <code class="language-plaintext highlighter-rouge">WalletConnectConnector</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">rpc</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">ChainId</span><span class="p">.</span><span class="nx">ETHEREUM</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">https://api.sushirelay.com/v1</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">[</span><span class="nx">ChainId</span><span class="p">.</span><span class="nx">ROPSTEN</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">https://eth-ropsten.alchemyapi.io/v2/cidKix2Xr-snU3f6f6Zjq_rYdalKKHmW</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// mainnet only</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">walletconnect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WalletConnectConnector</span><span class="p">({</span>
  <span class="na">rpc</span><span class="p">:</span> <span class="nx">RPC</span><span class="p">,</span>
  <span class="na">bridge</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://bridge.walletconnect.org</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">qrcode</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">supportedChainIds</span><span class="p">,</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Once the link is established all RPC requests goes to our nodeâ€¦ <strong>all of them except sending the TX</strong>. Neither our <code class="language-plaintext highlighter-rouge">eth_sendRawTransaction</code> or any other related rpc method is being called but despite that fact the tx is being relayed to the network and mined fine.</p>

<p>Below thereâ€™s an screenshot of my debugging session of yesterday that displays the configuration options and clearly we can see the WalletConnect object <code class="language-plaintext highlighter-rouge">wc</code> is correctly populated with our endpoint:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146018598-53fdf886-7d8c-4c9d-94e5-4e46f8c04b47.png" alt="image" /></p>

<p>After spending some time there are two potential scenarios that Iâ€™m considering and that I need more supporting evidence:</p>

<ul>
  <li>Trust Wallet is ignoring the RPC endpoint purposedly when using <code class="language-plaintext highlighter-rouge">library.getSigner().sendTransaction()</code> and is being sent using their preconfigured Infura / Alchemy or whatever account.</li>
  <li>Recently, couple of days ago, <a href="https://github.com/WalletConnect/walletconnect-monorepo/issues/663">it has been reported that <code class="language-plaintext highlighter-rouge">@walletconnect/ethereum-provider</code> library</a> (the one that under the surface Sushi is using) doesnâ€™t correctly fill the information correctly for the RPC in certain circumstances.</li>
</ul>

<h3 id="alternative-approach-sign-the-tx-ourselves">Alternative Approach: Sign the tx ourselves</h3>

<p>If, instead we take the route of signing the TX ourselves by using the same approach I described for MetaMask:</p>

<p><img src="https://user-images.githubusercontent.com/82811/145998002-bd773f01-8411-446f-aa05-a50af6de584f.png" alt="image" /></p>

<p>The following UI appears:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146021787-3a8f4333-695c-41d7-9349-eee449079161.png" alt="image" /></p>

<p>The algorithm for custom signing the Tx that I explained for MetaMask works in the following way:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146025356-409e1b5e-8627-44d8-83d4-f71c04a2e989.png" alt="image" /></p>

<p>Basically, we detect if the provider is MetaMask, if it is, we custom sign the whole tx:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nx">library</span>
    <span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">personal_sign</span><span class="dl">'</span><span class="p">,</span> <span class="na">params</span><span class="p">:</span> <span class="p">[</span><span class="nx">hexlify</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">getMessageToSign</span><span class="p">()),</span> <span class="nx">account</span><span class="p">]</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">signature</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">s</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">splitSignature</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span>
        <span class="c1">// really crossing the streams here</span>
        <span class="c1">// eslint-disable-next-line</span>
        <span class="c1">// @ts-ignore</span>
        <span class="kd">const</span> <span class="nx">txWithSignature</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">_processSignature</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">arrayify</span><span class="p">(</span><span class="nx">r</span><span class="p">),</span> <span class="nx">arrayify</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span> <span class="na">signedTx</span><span class="p">:</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txWithSignature</span><span class="p">.</span><span class="nx">serialize</span><span class="p">()),</span> <span class="nx">fullTx</span> <span class="p">}</span>
    <span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Otherwise, we rely on library connector implementation:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nx">library</span>
    <span class="p">.</span><span class="nx">getSigner</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">signTransaction</span><span class="p">(</span><span class="nx">fullTx</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">signedTx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">signedTx</span><span class="p">,</span> <span class="nx">fullTx</span> <span class="p">}</span>
    <span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Turns out that if we use <code class="language-plaintext highlighter-rouge">library.getSigner().signTransaction()</code> the ethers implementation of WalletConnect is not implemented at all as we can see below:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146023402-9e5802b0-1d8c-4aa8-86ea-9fea2c97196f.png" alt="image" /></p>

<p>If, by contrary, we force the code to use <code class="language-plaintext highlighter-rouge">library.provider.request({ method: 'personal_sign', params: [hexlify(tx.getMessageToSign()), account] })</code> line, the following happens UI appears:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146023969-70136612-129a-4027-91de-827286b2cae7.jpg" alt="photo_2021-12-14_16-04-34" /></p>

<p>Which is what we wantâ€¦ only that when we accept that button thereâ€™s no response back to Sushiâ€™s UI (neither an error or a result, so we canâ€™t react to that at all).</p>

<p>Caveats of this implementation:</p>

<ul>
  <li>Same as those described for MetaMask, we should prepare the UI to allow the user to tweak tx settings.</li>
  <li>Potentially research, understand, involve more parties and involve more parties to see whatâ€™s going on with the implementation of WalletConnect and why is behaving like that and prepare a fix (if necessary).</li>
</ul>

<h2 id="conclusions">Conclusions</h2>

<p>As I described, this only touches MetaMask and WalletConnect, I canâ€™t imagine if we need to support the other connectors. We can skip those for now, but even with that, we need to answer the questions I raised for the case of MetaMask and also those of WalletConnect if we are willing to support it at all.</p>

<h2 id="intro">Intro</h2>

<p>After spending more time yesterday reading more Sushiâ€™s codebase, reading the code of WalletConnect and MetaMask, reading a couple of Github issues and conducting tests, Iâ€™ve solved some problems that I presented yesterday. This comment is an update of my newly acquired knowledge and the progress I have made since:</p>

<h2 id="how-sushis-is-handling-connectors">How Sushiâ€™s is handling connectors</h2>

<p>First and foremost, Sushiâ€™s is wrapping <a href="https://github.com/NoahZinsmeister/web3-react (the library they use to handle connectivity to different Wallet providers)"><code class="language-plaintext highlighter-rouge">web3-react</code></a> connectors into an etherjs <a href="https://docs.ethers.io/v5/api/providers/"><code class="language-plaintext highlighter-rouge">Provider</code></a> interface. We can see that here:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146187134-5a99ecab-935f-48e2-88fa-ed1764d56f6b.png" alt="image" /></p>

<p>The function <code class="language-plaintext highlighter-rouge">getLibrary</code> is called way at the beginning of the <code class="language-plaintext highlighter-rouge">React App</code> as we can see below:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146187323-cc6c97bf-3226-4b1d-bc3c-6d05b8410b60.png" alt="image" /></p>

<p>Now, if we take a look into the implementation of ethersjs <code class="language-plaintext highlighter-rouge">Web3Provider</code>:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146187577-67ffd79e-ecd6-47cd-825d-77d94784be8b.png" alt="image" /></p>

<p>We can see that it extends <code class="language-plaintext highlighter-rouge">JsonRpcProvider</code>, and if we research the implementation, we discover the following:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146187870-c029c4e0-553e-4b09-831b-186a0e5dc50e.png" alt="image" /></p>

<p>So, that explains why whenever we were using the method <code class="language-plaintext highlighter-rouge">library.getSigner().signTransaction()</code> was throwing that error. Initially, I thought it was related to exclusively to <code class="language-plaintext highlighter-rouge">WalletConnectConnector</code> implementation.</p>

<p>This means, we need to use directly <code class="language-plaintext highlighter-rouge">library.provider</code> implementation and use it directly without intermediaries.</p>

<h2 id="the-issue-with-eth_sign-personal_sign-and-signedtypedata_v4">The issue with <code class="language-plaintext highlighter-rouge">eth_sign</code>, <code class="language-plaintext highlighter-rouge">personal_sign</code> and <code class="language-plaintext highlighter-rouge">signedTypeData_v4</code></h2>

<p><strong>UPDATE</strong>: We canâ€™t use <code class="language-plaintext highlighter-rouge">eth_signTypedData_v4</code> as it adds the <code class="language-plaintext highlighter-rouge">\x19Ethereum Signed Message:\n42aâ€¦</code> prefix (as is stated here in <a href="https://eips.ethereum.org/EIPS/eip-712#eth_signtypeddata">EIP-712</a>). So do <code class="language-plaintext highlighter-rouge">personal_sign</code>. We need to rely on only <code class="language-plaintext highlighter-rouge">eth_sign</code> directly. Also, for the part where I commented that TrustWallet was not answering initially, <code class="language-plaintext highlighter-rouge">eth_sign</code> was caused by my network connectivity issues with IPV6, which made me think that <code class="language-plaintext highlighter-rouge">eth_sign</code> was being ignored. Consider what you read below as practically invalid.</p>

<p>In this particular issue opened in etherjs repository called <a href="https://github.com/ethers-io/ethers.js/issues/1544">Use personal_sign instead of eth_sign for JSON-RPC</a>, thereâ€™s a discussion of the state of the art for <code class="language-plaintext highlighter-rouge">eth_sign</code>, <code class="language-plaintext highlighter-rouge">personal_sign</code> and related methods. This issue is particular useful as it explains why some wallets / implementations returns errors (like we were seeing with TrustWallet not answering <code class="language-plaintext highlighter-rouge">eth_sign</code> request).</p>

<p>We can see what <code class="language-plaintext highlighter-rouge">ricmoo</code> <a href="https://github.com/ethers-io/ethers.js/issues/1544#issue-877935690">has said related to the situation</a>:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146189613-fd8501e9-477a-4bf8-968e-8790ba5e3891.png" alt="image" /></p>

<p>User <code class="language-plaintext highlighter-rouge">alfetopito</code> <a href="https://github.com/ethers-io/ethers.js/issues/1544#issuecomment-833878616">adds the following</a>:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146189791-8d5c1b8e-93f0-44f4-bb02-ad16f387e1f3.png" alt="image" /></p>

<p>So the conclusion we need to extract is:</p>

<p>1) As a rule of thumb, always try to use <code class="language-plaintext highlighter-rouge">personal_sign</code> method first and resort to <code class="language-plaintext highlighter-rouge">eth_sign</code>
2) <code class="language-plaintext highlighter-rouge">eth_signTypedData_v4</code> can be used in these apps securely (just mentioning this but the initial version is not going to resort on this method by any means).</p>

<p><img src="https://user-images.githubusercontent.com/82811/146190697-67543d33-08df-442f-b086-1240dd1185ac.png" alt="image" /></p>

<h2 id="where-does-this-leave-us-right-now">Where does this leave us right now?</h2>

<p>I updated the implementation of <code class="language-plaintext highlighter-rouge">useSwapCallback</code> to reflect these newly discovered insight:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre></td><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">txResponse</span><span class="p">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TransactionResponseLight</span><span class="o">&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">useOpenMev</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">txResponse</span> <span class="o">=</span> <span class="nx">library</span><span class="p">.</span><span class="nx">getSigner</span><span class="p">().</span><span class="nx">sendTransaction</span><span class="p">({</span>
            <span class="na">from</span><span class="p">:</span> <span class="nx">account</span><span class="p">,</span>
            <span class="na">to</span><span class="p">:</span> <span class="nx">address</span><span class="p">,</span>
            <span class="na">data</span><span class="p">:</span> <span class="nx">calldata</span><span class="p">,</span>
            <span class="c1">// let the wallet try if we can't estimate the gas</span>
            <span class="p">...(</span><span class="dl">'</span><span class="s1">gasEstimate</span><span class="dl">'</span> <span class="k">in</span> <span class="nx">bestCallOption</span> <span class="p">?</span> <span class="p">{</span> <span class="na">gasLimit</span><span class="p">:</span> <span class="nx">calculateGasMargin</span><span class="p">(</span><span class="nx">bestCallOption</span><span class="p">.</span><span class="nx">gasEstimate</span><span class="p">)</span> <span class="p">}</span> <span class="p">:</span> <span class="p">{}),</span>
            <span class="na">gasPrice</span><span class="p">:</span> <span class="o">!</span><span class="nx">eip1559</span> <span class="o">&amp;&amp;</span> <span class="nx">chainId</span> <span class="o">===</span> <span class="nx">ChainId</span><span class="p">.</span><span class="nx">HARMONY</span> <span class="p">?</span> <span class="nx">BigNumber</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="dl">'</span><span class="s1">2000000000</span><span class="dl">'</span><span class="p">)</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
            <span class="p">...(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isZero</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">?</span> <span class="p">{</span> <span class="nx">value</span> <span class="p">}</span> <span class="p">:</span> <span class="p">{}),</span>
          <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Use OpenMEV`</span><span class="p">,</span> <span class="nx">useOpenMev</span><span class="p">)</span>

          <span class="kd">const</span> <span class="nx">supportedNetwork</span> <span class="o">=</span> <span class="nx">OPENMEV_SUPPORTED_NETWORKS</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">chainId</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportedNetwork</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Unknown chain id </span><span class="p">${</span><span class="nx">chainId</span><span class="p">}</span><span class="s2"> when building transaction`</span><span class="p">)</span>

          <span class="nx">txResponse</span> <span class="o">=</span> <span class="nx">library</span>
            <span class="p">.</span><span class="nx">getSigner</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">populateTransaction</span><span class="p">({</span>
              <span class="na">from</span><span class="p">:</span> <span class="nx">account</span><span class="p">,</span>
              <span class="na">to</span><span class="p">:</span> <span class="nx">address</span><span class="p">,</span>
              <span class="na">data</span><span class="p">:</span> <span class="nx">calldata</span><span class="p">,</span>
              <span class="c1">// let the wallet try if we can't estimate the gas</span>
              <span class="p">...(</span><span class="dl">'</span><span class="s1">gasEstimate</span><span class="dl">'</span> <span class="k">in</span> <span class="nx">bestCallOption</span> <span class="p">?</span> <span class="p">{</span> <span class="na">gasLimit</span><span class="p">:</span> <span class="nx">calculateGasMargin</span><span class="p">(</span><span class="nx">bestCallOption</span><span class="p">.</span><span class="nx">gasEstimate</span><span class="p">)</span> <span class="p">}</span> <span class="p">:</span> <span class="p">{}),</span>
              <span class="p">...(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isZero</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">?</span> <span class="p">{</span> <span class="nx">value</span> <span class="p">}</span> <span class="p">:</span> <span class="p">{}),</span>
              <span class="p">...(</span><span class="o">!</span><span class="nx">eip1559</span> <span class="p">?</span> <span class="p">{</span> <span class="na">gasPrice</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">:</span> <span class="p">{}),</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">txReq</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`EIP1559`</span><span class="p">,</span> <span class="nx">eip1559</span><span class="p">)</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`FullTX`</span><span class="p">,</span> <span class="nx">txReq</span><span class="p">)</span>

              <span class="kd">const</span> <span class="nx">tx</span> <span class="o">=</span> <span class="nx">TransactionFactory</span><span class="p">.</span><span class="nx">fromTxData</span><span class="p">(</span>
                <span class="p">{</span>
                  <span class="na">type</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="kd">type</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="kd">type</span><span class="p">)</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">chainId</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">chainId</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">chainId</span><span class="p">)</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">nonce</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">nonce</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">nonce</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">gasPrice</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">gasPrice</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">gasPrice</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">gasLimit</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">gasLimit</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">gasLimit</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">maxFeePerGas</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">maxFeePerGas</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">maxFeePerGas</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">maxPriorityFeePerGas</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">maxPriorityFeePerGas</span>
                    <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">maxPriorityFeePerGas</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span>
                    <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">to</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span>
                  <span class="na">value</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">value</span> <span class="p">?</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txReq</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="na">hexPad</span><span class="p">:</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span> <span class="p">})</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span>
                  <span class="na">data</span><span class="p">:</span> <span class="nx">txReq</span><span class="p">.</span><span class="nx">data</span><span class="p">?.</span><span class="nx">toString</span><span class="p">(),</span>
                <span class="p">},</span>
                <span class="p">{</span>
                  <span class="na">common</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Common</span><span class="p">({</span>
                    <span class="na">chain</span><span class="p">:</span> <span class="nx">chainId</span><span class="p">,</span>
                    <span class="na">hardfork</span><span class="p">:</span> <span class="dl">'</span><span class="s1">berlin</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">eips</span><span class="p">:</span> <span class="nx">eip1559</span> <span class="p">?</span> <span class="p">[</span><span class="mi">1559</span><span class="p">]</span> <span class="p">:</span> <span class="p">[],</span>
                  <span class="p">}),</span>
                <span class="p">}</span>
              <span class="p">)</span>

              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`TX`</span><span class="p">,</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

              <span class="k">return</span> <span class="nx">library</span><span class="p">.</span><span class="nx">provider</span>
                <span class="p">.</span><span class="nx">request</span><span class="p">({</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">personal_sign</span><span class="dl">'</span><span class="p">,</span> <span class="na">params</span><span class="p">:</span> <span class="p">[</span><span class="nx">hexlify</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">getMessageToSign</span><span class="p">()),</span> <span class="nx">account</span><span class="p">]</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">signature</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                  <span class="kd">const</span> <span class="p">{</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">s</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">splitSignature</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span>
                  <span class="c1">// really crossing the streams here</span>
                  <span class="c1">// eslint-disable-next-line</span>
                  <span class="c1">// @ts-ignore</span>
                  <span class="kd">const</span> <span class="nx">txWithSignature</span> <span class="o">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">_processSignature</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">arrayify</span><span class="p">(</span><span class="nx">r</span><span class="p">),</span> <span class="nx">arrayify</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
                  <span class="k">return</span> <span class="p">{</span> <span class="na">signedTx</span><span class="p">:</span> <span class="nx">hexlify</span><span class="p">(</span><span class="nx">txWithSignature</span><span class="p">.</span><span class="nx">serialize</span><span class="p">()),</span> <span class="na">fullTx</span><span class="p">:</span> <span class="nx">txReq</span> <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">signedTx</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="kd">const</span> <span class="nx">relayURI</span> <span class="o">=</span> <span class="nx">chainId</span> <span class="p">?</span> <span class="nx">OPENMEV_URI</span><span class="p">[</span><span class="nx">chainId</span><span class="p">]</span> <span class="p">:</span> <span class="kc">undefined</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relayURI</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`Could not determine Sushi Relay URI for this network: </span><span class="p">${</span><span class="nx">chainId</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

              <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="na">jsonrpc</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2.0</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">id</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
                <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">eth_sendRawTransaction</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">params</span><span class="p">:</span> <span class="p">[</span><span class="nx">signedTx</span><span class="p">],</span>
              <span class="p">})</span>

              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Sending to URI: </span><span class="p">${</span><span class="nx">relayURI</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Body:`</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>

              <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">relayURI</span><span class="p">,</span> <span class="p">{</span>
                <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
                <span class="nx">body</span><span class="p">,</span>
                <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                  <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
                <span class="p">},</span>
              <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="na">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">// Handle success</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">json</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="c1">// But first check if there are some errors first and throw accordingly</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">json</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

                    <span class="c1">// Otherwise return a TransactionResponseLight object</span>
                    <span class="k">return</span> <span class="p">{</span> <span class="na">hash</span><span class="p">:</span> <span class="nx">json</span><span class="p">.</span><span class="nx">result</span> <span class="p">}</span> <span class="k">as</span> <span class="nx">TransactionResponseLight</span>
                  <span class="p">})</span>
                <span class="p">}</span>

                <span class="c1">// Generic error</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">)</span>
              <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This leaves the algorithm like:</p>

<p>1) If user does not have enabled OpenMEV, continue like previousy.
2) If it does then:
  1) Populate the transaction information by using <code class="language-plaintext highlighter-rouge">library.getSigner().populateTransaction()</code> method
  2) Convert the resulting tx from <code class="language-plaintext highlighter-rouge">ethersjs</code> to raw by using <code class="language-plaintext highlighter-rouge">TransactionFactory.fromTxData</code> helper
  3) Send the information to be signed by the wallet, right now using <code class="language-plaintext highlighter-rouge">personal_sign</code> but we should take into account failure and retry with <code class="language-plaintext highlighter-rouge">eth_sign</code>.
  4) Send the TX to our RPC endpoint.
3) Update UI accordingly.</p>

<p>So far Iâ€™ve been testing with:</p>

<ul>
  <li>Chrome MetaMask</li>
  <li>iOS MetaMask</li>
  <li>iOS TrustWallet</li>
</ul>

<p>And all of them are able to sign and send the TX to the relay. Thereâ€™s still some issues with Txs failing:</p>

<p><img src="https://user-images.githubusercontent.com/82811/146192083-b2153c3e-27ed-40b1-9612-c96e3bbf1114.png" alt="image" /></p>

<p>That I need to research why is happening whenever I have the basic flow tested and pushed to our repository.</p>

<p>Sushi is calculating TX gas price and other metrics by default, so as a first version where the user is not going to customize TX details like <code class="language-plaintext highlighter-rouge">GasPrice</code>, <code class="language-plaintext highlighter-rouge">MaxFeePerGas</code> and so on can work. We need still, to coordinate with them how we can create a UI that takes that into account. But one step at a time.</p>


        <!-- Post Pager -->
        <div>
          <hr style="visibility: hidden" />
          <ul class="pager"><li class="previous">
              <a
                href="/primitives/2021/12/10/Gas_Reporting.html"
                data-toggle="tooltip"
                data-placement="top"
                title="Gas Pricing Index"
              >
                Previous<br />
                <span>Gas Pricing Index</span>
              </a>
            </li></ul>
          <hr style="visibility: hidden" />
        </div><!-- Comments -->
<script
  src="https://utteranc.es/client.js"
  repo="sambacha/comments"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async
></script></div><!-- Side Catalog Container -->
      <div
        class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"
      >
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs" />
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div><!-- Sidebar Container -->
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"
      ><!-- Featured Tags -->
<section><hr class="hidden-sm hidden-xs"><h5>
        <a href="/primitives/archive/">FEATURED TAGS</a>
    </h5>
    <div class="tags"><a data-sort="0002"
            href="/primitives/archive/?tag=blockchain"
            title="blockchain"
            rel="5">blockchain</a><a data-sort="0002"
            href="/primitives/archive/?tag=distributed+computing"
            title="distributed computing"
            rel="5">distributed computing</a><a data-sort="0002"
            href="/primitives/archive/?tag=ethereum"
            title="ethereum"
            rel="5">ethereum</a><a data-sort="0004"
            href="/primitives/archive/?tag=dao"
            title="dao"
            rel="3">dao</a><a data-sort="0004"
            href="/primitives/archive/?tag=governance"
            title="governance"
            rel="3">governance</a><a data-sort="0006"
            href="/primitives/archive/?tag=Jekyll"
            title="Jekyll"
            rel="1">Jekyll</a><a data-sort="0006"
            href="/primitives/archive/?tag=Markdown"
            title="Markdown"
            rel="1">Markdown</a><a data-sort="0006"
            href="/primitives/archive/?tag=flashbots"
            title="flashbots"
            rel="1">flashbots</a><a data-sort="0006"
            href="/primitives/archive/?tag=mev"
            title="mev"
            rel="1">mev</a>
    </div>
</section>
</div>
    </div>
  </div>
</article>
<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><!-- SNS -->
<ul class="list-inline text-center">
  
  <li>
    <a href="/primitives/feed.xml">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="mailto:sam@manifoldfinance.com">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li><li>
    <a target="_blank" href="https://github.com/sambacha">
      <span class="fa-stack fa-lg">
        <i class="fas fa-circle fa-stack-2x fa-inverse"></i>
        <i class="fab fa-github fa-stack-2x"></i>
      </span>
    </a>
  </li></ul>
<p class="copyright text-muted">See
          <a href="https://github.com/sambacha"></a> @sambacha | &copy; 2021 sambacha
        </p>
      </div>
    </div>
  </div>
</footer>

<!-- jQuery -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
  integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
  crossorigin="anonymous"
></script>

<!-- Bootstrap JavaScript-->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
  integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
  crossorigin="anonymous"
></script>

<!-- Simple Jekyll Search -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.7.12/simple-jekyll-search.min.js"
  integrity="sha512-APy7Ff/y4pdIHleqiTMcRZ8Wu6tjfqhJpgAcaCvTuFQPj/G+/A5u0uZi/DkfkuLQ6FeFmDJgh/zl0y3If/VUyA=="
  crossorigin="anonymous"
></script>

<!-- MathJax https://github.com/mathjax/MathJax/issues/2220 -->
<script>
  MathJax = {
    options: {
      renderActions: {
        /* add a new named action not to override the original 'find' action */
        find_script_mathtex: [
          10,
          function (doc) {
            for (const node of document.querySelectorAll(
              'script[type^="math/tex"]',
            )) {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(
                node.textContent,
                doc.inputJax[0],
                display,
              );
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = { node: text, delim: '', n: 0 };
              math.end = { node: text, delim: '', n: 0 };
              doc.math.push(math);
            }
          },
          '',
        ],
      },
    },
  };
</script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/tex-chtml.js"
  integrity="sha512-WIPUeuVusAT6dUtN6xKArYCBEa76ltyvaz3ltvQd+dy7ISdGJv1Y3y7eDBEF986YfNtmZGLdAaEBSgeBb+8OSg=="
  crossorigin="anonymous"
></script>

<!-- Async load function -->
<script>
  function async(u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener(
        'load',
        function (e) {
          c(null, e);
        },
        false,
      );
    }
    s.parentNode.insertBefore(o, s);
  }
</script><!-- AnchorJS -->
<script>
  async(
    'https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js',
    function () {
      anchors.options = {
        visible: 'hover',
      };
      anchors
        .add()
        .remove('.intro-header h1')
        .remove('.subheading')
        .remove('.sidebar-container h5');
    },
  );
</script><!-- Custom JavaScript -->
<script src="/primitives/assets/js/main.js"></script><!-- Side Catalog -->
<script src="/primitives/assets/js/catalog.js"></script></body>
</html>
